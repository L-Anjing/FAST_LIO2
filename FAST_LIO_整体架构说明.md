# FAST-LIO é¡¹ç›®å®Œæ•´æ¶æ„è¯´æ˜

## ğŸ“Š æ•´ä½“ç³»ç»Ÿæ¡†æ¶

```
FAST-LIO (Fast LIDAR-Inertial Odometry)
â”œâ”€â”€ è¾“å…¥å±‚
â”‚   â”œâ”€â”€ æ¿€å…‰é›·è¾¾ç‚¹äº‘ (ROS Topic: /livox/lidar)
â”‚   â”‚   â””â”€â”€ æ”¯æŒæ ¼å¼: Livox CustomMsg / Standard PointCloud2
â”‚   â””â”€â”€ IMU æ•°æ® (ROS Topic: /livox/imu)
â”‚
â”œâ”€â”€ å¤„ç†å±‚ (æ ¸å¿ƒç®—æ³•)
â”‚   â”œâ”€â”€ 1. ç‚¹äº‘é¢„å¤„ç† (Preprocess)
â”‚   â”œâ”€â”€ 2. IMU ç§¯åˆ†ä¸è¿åŠ¨è¡¥å¿ (IMU_Processing)
â”‚   â”œâ”€â”€ 3. ç‰¹å¾æå–ä¸åŒ¹é… (KDTree æœç´¢)
â”‚   â””â”€â”€ 4. EKF èåˆä¸ä½å§¿ä¼˜åŒ– (IKFoM)
â”‚
â””â”€â”€ è¾“å‡ºå±‚
    â”œâ”€â”€ é‡Œç¨‹è®¡ (Odometry)
    â”œâ”€â”€ ç‚¹äº‘åœ°å›¾ (Map)
    â””â”€â”€ è½¨è¿¹ (Path)
```

---

## ğŸ”´ æ ¸å¿ƒä¸‰å¤§æ¨¡å—ï¼ˆé‡ç‚¹è¦çœ‹ï¼‰

### **1ï¸âƒ£ ç‚¹äº‘é¢„å¤„ç†æ¨¡å—** [preprocess.cpp/h]
**æ–‡ä»¶**: `src/preprocess.cpp` (959 è¡Œ)
**å…³é”®ç±»**: `Preprocess`

#### ä¸»è¦å‡½æ•°æµç¨‹ï¼š
```
process() 
  â†“
[é€‰æ‹©æ•°æ®æº]
  â”œâ”€ Livox æ ¼å¼ â†’ avia_handler()
  â””â”€ ROS PointCloud2 â†’ é€‰æ‹©å¯¹åº” handler
      â”œâ”€ oust64_handler() [Ouster 64çº¿]
      â”œâ”€ velodyne_handler() [Velodyne]
      â””â”€ sim_handler() [æ¨¡æ‹Ÿæ•°æ®]
  â†“
é€çº¿å¤„ç†
  â†“
give_feature() â­ï¸â­ï¸â­ï¸ã€æ ¸å¿ƒã€‘
  â”œâ”€ plane_judge() â†’ åˆ¤æ–­æ˜¯å¦ä¸ºå¹³é¢
  â”œâ”€ edge_jump_judge() â†’ åˆ¤æ–­è¾¹ç¼˜è·³å˜
  â””â”€ ç‰¹å¾åˆ†ç±»
     â”œâ”€ Real_Plane (ç¡®å®šå¹³é¢ç‚¹) â†’ pl_surf
     â”œâ”€ Edge_Jump / Edge_Plane (è¾¹ç¼˜ç‚¹) â†’ pl_corn
     â””â”€ Nor (æ™®é€šç‚¹) â†’ è¿‡æ»¤æˆ–å¤„ç†
```

**è¾“å‡º**: 
- `pl_surf`: å¹³é¢ç‚¹äº‘ (ç”¨äº mapping)
- `pl_corn`: è¾¹ç¼˜ç‚¹äº‘ (ç‰¹å¾æå–æ¨¡å¼æ‰æœ‰)

#### å…³é”®å‚æ•°ï¼š
| å‚æ•° | é»˜è®¤å€¼ | å«ä¹‰ |
|-----|-------|------|
| `blind` | 0.01m | ç›²åŒºé˜ˆå€¼ï¼ˆè¿‡æ»¤è¿‘ç‚¹ï¼‰ |
| `point_filter_num` | 1 | é‡‡æ ·é—´éš” |
| `N_SCANS` | 6 | æ¿€å…‰çº¿æ•° |
| `p2l_ratio` | 225 | ç‚¹åˆ°å¹³é¢çš„åˆ¤æ–­é˜ˆå€¼ |
| `disA, disB` | 0.01, 0.1 | è·ç¦»åˆ¤æ–­å‚æ•° |

---

### **2ï¸âƒ£ IMU å¤„ç†ä¸è¿åŠ¨è¡¥å¿** [IMU_Processing.hpp]
**æ–‡ä»¶**: `include/IMU_Processing.hpp`
**å…³é”®ç±»**: `IMUProcess`

#### ä¸»è¦åŠŸèƒ½ï¼š
```
Process(Measures, kf, feats_undistort)
  â†“
1. é™€èºä»ªç§¯åˆ† (é¢„ç§¯åˆ†)
  â”œâ”€ è®¡ç®—æ—‹è½¬ R(t)
  â””â”€ ç´¯ç§¯åå·® bias
  â†“
2. åŠ é€Ÿåº¦è®¡ç§¯åˆ†
  â”œâ”€ è®¡ç®—é€Ÿåº¦ v(t)
  â””â”€ è®¡ç®—ä½ç½® p(t)
  â†“
3. è¿åŠ¨è¡¥å¿ (Undistortion)
  â””â”€ å°†æ¯ä¸ªç‚¹ä»æ¿€å…‰å‘å°„æ—¶åˆ»
    å˜æ¢åˆ°æ‰«æç»“æŸæ—¶åˆ»
```

**è¾“å…¥**: `feats_undistort` (ç»è¿‡è¿åŠ¨è¡¥å¿çš„ç‚¹äº‘)

---

### **3ï¸âƒ£ åœ°å›¾ä¸ä½å§¿ä¼˜åŒ–** [laserMapping.cpp]
**æ–‡ä»¶**: `src/laserMapping.cpp` (1178 è¡Œ)
**å…³é”®ç±»**: `esekf<state_ikfom>`

#### ä¸»ç®—æ³•æµç¨‹ (ç¬¬950-1100è¡Œçš„ä¸»å¾ªç¯)ï¼š

```
â”Œâ”€ ä¸»å¾ªç¯ while(ros::ok()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚ 1. åŒæ­¥æ•°æ®åŒ… (sync_packages)                  â”‚
â”‚    â”œâ”€ ä»ç¼“å†²åŒºå–æ¿€å…‰é›·è¾¾å¸§                    â”‚
â”‚    â””â”€ å–å¯¹åº”æ—¶é—´å†…çš„æ‰€æœ‰ IMU æ•°æ®              â”‚
â”‚                                                 â”‚
â”‚ 2. IMU å¤„ç†ä¸è¿åŠ¨è¡¥å¿                          â”‚
â”‚    â””â”€ p_imu->Process() â†’ è¾“å‡º feats_undistort â”‚
â”‚                                                 â”‚
â”‚ 3. åœ°å›¾ FOV åˆ†å‰²                               â”‚
â”‚    â””â”€ lasermap_fov_segment()                  â”‚
â”‚       â””â”€ ç»´æŠ¤å±€éƒ¨åœ°å›¾ç«‹æ–¹ä½“ï¼Œåˆ é™¤è·ç¦»è¿œçš„ç‚¹  â”‚
â”‚                                                 â”‚
â”‚ 4. ä½“ç´ åŒ–ä¸‹é‡‡æ ·                                â”‚
â”‚    â””â”€ downSizeFilterSurf é™é‡‡æ ·               â”‚
â”‚       â””â”€ è¾“å‡º feats_down_body                 â”‚
â”‚                                                 â”‚
â”‚ 5. ã€å…³é”®ã€‘ICP ä¸è¿­ä»£ EKF ä¼˜åŒ–                 â”‚
â”‚    â”œâ”€ KDTree æœç´¢æœ€è¿‘é‚»                        â”‚
â”‚    â”‚  â””â”€ åœ¨åœ°å›¾ä¸­æœç´¢æ¯ä¸ªç‚¹çš„è¿‘é‚»              â”‚
â”‚    â”œâ”€ è®¡ç®— Jacobian çŸ©é˜µ (h_share_model)      â”‚
â”‚    â”‚  â””â”€ ç‚¹åˆ°å¹³é¢è·ç¦»ä½œä¸ºè§‚æµ‹é‡                â”‚
â”‚    â””â”€ EKF æ›´æ–°                                â”‚
â”‚       â””â”€ kf.update_iterated_dyn_share_modified()
â”‚          â””â”€ ä¼˜åŒ–: ä½ç½®ã€é€Ÿåº¦ã€IMU biasã€å¤–å‚  â”‚
â”‚                                                 â”‚
â”‚ 6. åœ°å›¾æ›´æ–°                                    â”‚
â”‚    â””â”€ map_incremental()                       â”‚
â”‚       â””â”€ å°†å¤„ç†åçš„ç‚¹åŠ å…¥ KDTree åœ°å›¾          â”‚
â”‚                                                 â”‚
â”‚ 7. å‘å¸ƒç»“æœ                                    â”‚
â”‚    â”œâ”€ Odometry (é‡Œç¨‹è®¡)                       â”‚
â”‚    â”œâ”€ PointCloud2 (åœ°å›¾)                      â”‚
â”‚    â””â”€ Path (è½¨è¿¹)                             â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æ•°æ®æµä¸å…³é”®å˜é‡

### æ•°æ®æµå‘ï¼š
```
ROS è®¢é˜…å›è°ƒ
  â”œâ”€ livox_pcl_cbk()     [Livox ç‚¹äº‘]
  â”œâ”€ standard_pcl_cbk()  [å…¶ä»–ç‚¹äº‘]
  â””â”€ imu_cbk()           [IMU æ•°æ®]
    â†“
ç¼“å†²åŒº (buffer)
  â”œâ”€ lidar_buffer   [ç‚¹äº‘ç¼“å­˜]
  â””â”€ imu_buffer     [IMU ç¼“å­˜]
    â†“
sync_packages() åŒæ­¥
    â†“
å¤„ç†çº¿ç¨‹ (main loop)
    â†“
[é¢„å¤„ç†] â†’ [IMUè¡¥å¿] â†’ [ä¸‹é‡‡æ ·] â†’ [KDTreeæœç´¢] â†’ [EKFä¼˜åŒ–] â†’ [åœ°å›¾æ›´æ–°]
    â†“
å‘å¸ƒç»“æœ
```

### å…³é”®å…¨å±€å˜é‡ï¼š
- `feats_undistort`: å»è¿åŠ¨ç•¸å˜çš„ç‰¹å¾ç‚¹ (body frame)
- `feats_down_body`: ä¸‹é‡‡æ ·åçš„ç‰¹å¾ç‚¹ (body frame)
- `feats_down_world`: ç‰¹å¾ç‚¹è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç³»
- `ikdtree`: åŠ¨æ€ KD-Tree åœ°å›¾
- `state_point`: EKF çŠ¶æ€ (ä½ç½®ã€é€Ÿåº¦ã€æ—‹è½¬ã€IMU biasã€å¤–å‚)
- `Measures`: åŒæ­¥çš„æ¿€å…‰é›·è¾¾å’Œ IMU æ•°æ®åŒ…

---

## ğŸ¯ é…ç½®æ–‡ä»¶è¯´æ˜

**ä¸»é…ç½®æ–‡ä»¶**: `config/mapping/*.yaml` (ä¾‹: `mid360.yaml`)

```yaml
# é¢„å¤„ç†å‚æ•°
preprocess:
  lidar_type: 1          # 1=Livox AVIA, 2=Velodyne, 3=Ouster
  scan_line: 6           # æ¿€å…‰çº¿æ•°
  blind: 0.01            # ç›²åŒºé˜ˆå€¼ (m)
  timestamp_unit: US     # æ—¶é—´æˆ³å•ä½
  
# æ»¤æ³¢å‚æ•°
filter_size_corner: 0.5  # è¾¹ç¼˜ç‚¹ä¸‹é‡‡æ ·æ ¼å­å¤§å°
filter_size_surf: 0.5    # å¹³é¢ç‚¹ä¸‹é‡‡æ ·æ ¼å­å¤§å°
filter_size_map: 0.5     # åœ°å›¾ä¸‹é‡‡æ ·æ ¼å­å¤§å°
cube_side_length: 200    # å±€éƒ¨åœ°å›¾ç«‹æ–¹ä½“è¾¹é•¿

# EKF å‚æ•°
mapping:
  gyr_cov: 0.1           # é™€èºä»ªå™ªå£°æ–¹å·®
  acc_cov: 0.1           # åŠ é€Ÿåº¦è®¡å™ªå£°æ–¹å·®
  b_gyr_cov: 0.0001      # é™€èºä»ª bias æ–¹å·®
  b_acc_cov: 0.0001      # åŠ é€Ÿåº¦è®¡ bias æ–¹å·®
  extrinsic_est_en: true # æ˜¯å¦ä¼°è®¡æ¿€å…‰-IMU å¤–å‚
```

---

## ğŸ”§ é‡è¦ä¿®æ”¹ç‚¹

### å¦‚æœä½ è¦ä¿®æ”¹çš„æ˜¯ï¼š

#### 1. **æ”¹å˜æ¿€å…‰é›·è¾¾ç±»å‹**
   - ä¿®æ”¹é…ç½® `config/reloc/mid360.yaml `æ–‡ä»¶ä¸­ `preprocess/lidar_type`
   - æˆ–åœ¨ `laserMapping.cpp` ä¸­ä¿®æ”¹ç›¸åº” handler

#### 2. **è°ƒæ•´ç‰¹å¾ç‚¹æå–æ•ˆæœ**
   - ä¿®æ”¹ `preprocess.cpp` ä¸­çš„ `give_feature()` å‡½æ•°
   - è°ƒæ•´å¹³é¢åˆ¤æ–­é˜ˆå€¼ `p2l_ratio`, `disA`, `disB`
   - ä¿®æ”¹ `blind` å»æ‰è¿‘ç‚¹

#### 3. **ä¼˜åŒ– EKF æ»¤æ³¢**
   - ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­ `gyr_cov`, `acc_cov` ç­‰å™ªå£°å‚æ•°
   - æˆ–æ”¹ `laserMapping.cpp` ä¸­çš„ `epsi[]` æ•°ç»„

#### 4. **æ”¹å˜åœ°å›¾æ›´æ–°é€Ÿåº¦**
   - ä¿®æ”¹ `filter_size_map` å‚æ•°
   - æˆ–æ”¹ `cube_side_length` (æ›´å¤§ = æ›´å¿«ä½†å†…å­˜å¤š)

#### 5. **è¾“å‡ºè‡ªå®šä¹‰æ•°æ®**
   - åœ¨ `publish_frame_world()` ç­‰å‘å¸ƒå‡½æ•°ä¸­æ·»åŠ è‡ªå·±çš„é€»è¾‘
   - æˆ–åœ¨ main loop çš„é€‚å½“ä½ç½®æ·»åŠ å¤„ç†

---

## ğŸ“Œ è¿è¡Œæµç¨‹æ€»ç»“

```
roslaunch fast_lio mapping_mid360.launch
  â†“
1. main() åˆå§‹åŒ–
   â”œâ”€ è¯»å–é…ç½®å‚æ•°
   â”œâ”€ åˆ›å»º Preprocess å¯¹è±¡
   â”œâ”€ åˆ›å»º IMUProcess å¯¹è±¡
   â””â”€ åˆå§‹åŒ– EKF æ»¤æ³¢å™¨
  â†“
2. è®¢é˜…ä¼ æ„Ÿå™¨æ•°æ®
   â”œâ”€ ç¼“å­˜æ¿€å…‰ç‚¹äº‘
   â””â”€ ç¼“å­˜ IMU æ•°æ®
  â†“
3. ä¸»å¤„ç†å¾ªç¯ (500ms)
   [é¢„å¤„ç†] â†’ [IMUè¡¥å¿] â†’ [ç‰¹å¾åŒ¹é…] â†’ [EKFä¼˜åŒ–] â†’ [åœ°å›¾æ›´æ–°]
  â†“
4. å‘å¸ƒç»“æœ
   â””â”€ Odometry, PointCloud2, Path
```

---

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é™ä½è®¡ç®—é‡**:
   - å¢å¤§ `filter_size_*` å‚æ•°
   - å¢åŠ  `point_filter_num` (é‡‡æ ·é—´éš”)
   - å‡å°‘ `max_iteration` æ¬¡æ•°

2. **æé«˜ç²¾åº¦**:
   - å‡å° `filter_size_*` å‚æ•°
   - è°ƒæ•´ `gyr_cov`, `acc_cov` æ›´å°
   - å¯ç”¨ `extrinsic_est_en` è‡ªåŠ¨æ ¡å‡†å¤–å‚

3. **å†…å­˜ç®¡ç†**:
   - å‡å° `cube_side_length` (åœ°å›¾å¤§å°)
   - å®šæœŸä¿å­˜ PCD æ–‡ä»¶ (pcd_save_en)
   - æ¸…ç†å†å²åœ°å›¾ç‚¹

